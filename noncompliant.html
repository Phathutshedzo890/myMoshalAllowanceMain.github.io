<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-Compliant Students Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css">
    
    <style>
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          font-family: Arial, sans-serif;
          
        }
    
        body {
          background-color: #f8f8f8;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
          height: 100vh;
          margin: 0;
          position: sticky;
          overflow-y: hidden;
        }
    
    
        h1 {
          font-weight: bold;
          margin: 0;
          text-align: center;
          margin-top: 50px;
        }
    
        p {
          font-size: 14px;
          font-weight: 100;
          line-height: 20px;
          margin: 20px 0 30px;
          text-align: center;
        }
    
        button {
          border-radius: 20px;
          border: 1px solid #3f62af;
          background-color: #3f62af;
          color: #ffffff;
          font-size: 12px;
          font-weight: bold;
          padding: 12px 45px;
          letter-spacing: 1px;
          text-transform: uppercase;
          transition: transform 80ms ease-in;
          cursor: pointer;
        }
    
        button.ghost {
          background-color: transparent;
          border-color: #ffffff;
        }
    
        button:focus {
          outline: none;
        }
    
        button:active {
          transform: scale(0.95);
        }
    
        footer {
          text-align: center;
          padding: 20px;
          background: #f8f8f8;
          
        }
    
        footer p {
          margin: 5px 0;
        }
    
        footer a {
          margin: 0 10px;
          text-decoration: none;
          color: #3f62af;
        }
    
        table {
          width: 90%;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 2px 5px #3f62af;
        margin-left: 50px;
        }
        
        th, td {
          padding: 12px 15px;
          border: 1px solid #ddd;
        }
        
        th {
          background-color: #3f62af;
          color: white;
        }
        
        td {
          word-wrap: break-word;
        }
    
        .message-column {
          width: 40%;
        }
    
        .action-btn {
          background-color: #3f62af;
          color: white;
          padding: 5px 10px;
          border: none;
          cursor: pointer;
          border-radius: 5px;
          font-size: 14px;
        }
    
        .action-btn:hover {
          background-color: #2e4b87;
        }
    
        @media (max-width: 768px) {
          main.container {
            width: 90%;
          }
        }
      </style>
</head>
<body>
 <!-- Go Back Navigation -->
 <div class="navigation" style="margin-left: 25px; margin-top: 15px; margin-bottom: 5px;">
    <a href="outstanding_students_updates.html" class="go-back" style="color: #000"
      >‚Üê Go Back</a
    >
  </div>

    <h2 class="section-title" style="text-align: center;"><i class="ri-error-warning-line"></i> Non-Compliant Students</h2>
    <section class="non-compliant-table">
        <table id="non-compliant-table">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Missing Documents</th>
                    <th>Days Since Last Update</th>
                    <th>Severity</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be dynamically added here -->
            </tbody>
        </table>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        // Firebase configuration (replace with your config)
        const firebaseConfig = {
            apiKey: "AIzaSyDUtGUh3WRQ9ZMpvOm26ZGVP9O_brS4jKg",
            authDomain: "mymoshalallowance.firebaseapp.com",
            databaseURL: "https://mymoshalallowance-default-rtdb.firebaseio.com",
            projectId: "mymoshalallowance",
            storageBucket: "mymoshalallowance.appspot.com",
            messagingSenderId: "607619034226",
            appId: "1:607619034226:web:e9c117dea2ccf9bd59e6eb",
            measurementId: "G-NCTW2CSPR8"
        };

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);

        // Fetch non-compliant students and display in the table
        async function fetchNonCompliantStudents() {
            const nonCompliantTable = document.getElementById('non-compliant-table').getElementsByTagName('tbody')[0];
            nonCompliantTable.innerHTML = ''; // Clear the table before adding new rows

            try {
                // Get all students
                const studentsSnapshot = await getDocs(collection(db, 'Student'));
                for (const studentDoc of studentsSnapshot.docs) {
                    const studentID = studentDoc.id;
                    const studentData = studentDoc.data();
                    
                    // Check for missing documents
                    const missingDocuments = await checkMissingDocuments(studentID);
                    if (missingDocuments.length >= 2) {  // Changed to check for 2 or more missing documents
                        const lastUpdate = studentData.LastUpdate || new Date();
                        const daysSinceUpdate = calculateDaysSince(lastUpdate);

                        const severity = getSeverity(daysSinceUpdate);

                        const row = createNonCompliantRow({
                            studentName: `${studentData.Student_FName} ${studentData.Student_LName}`,
                            missingDocuments,
                            daysSinceUpdate,
                            severity
                        });
                        nonCompliantTable.appendChild(row);
                    }
                }
            } catch (error) {
                console.error('Error fetching non-compliant students:', error);
            }
        }

        // Function to check missing documents for a student
        async function checkMissingDocuments(studentID) {
            const missingDocs = [];
            const docTypes = ['feeStatements', 'proofOfFunding', 'ExternalFunding'];
            for (let docType of docTypes) {
                const snapshot = await getDocs(collection(db, docType));
                const docExists = snapshot.docs.some(doc => doc.id === studentID);
                if (!docExists) {
                    missingDocs.push(docType);
                }
            }
            return missingDocs;
        }

        // Function to calculate the number of days since the last update
        function calculateDaysSince(lastUpdate) {
            const currentDate = new Date();
            const lastUpdateDate = new Date(lastUpdate);
            const timeDiff = currentDate - lastUpdateDate;
            const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24)); // Convert milliseconds to days
            return daysDiff;
        }

        // Function to determine severity based on days since last update
        function getSeverity(daysSinceUpdate) {
            if (daysSinceUpdate < 30) {
                return 'Low';
            } else if (daysSinceUpdate < 60) {
                return 'Medium';
            } else {
                return 'High';
            }
        }

        // Function to create a row for the non-compliant student
        function createNonCompliantRow(data) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${data.studentName}</td>
                <td>${data.missingDocuments.join(', ')}</td>
                <td>${data.daysSinceUpdate} days</td>
                <td class="${data.severity.toLowerCase()}-risk">${data.severity}</td>
            `;
            return row;
        }

        // Call the fetch function once the page has loaded
        document.addEventListener('DOMContentLoaded', function() {
            fetchNonCompliantStudents();
        });
    </script>

<footer>
    <p>&copy; 2024 MyWebsite. All rights reserved.</p>
    <p>
      <a href="#">Privacy Policy</a>
      <a href="#">Terms of Service</a>
    </p>
  </footer>
</body>
</html>